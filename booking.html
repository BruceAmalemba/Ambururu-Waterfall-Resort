<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Book your stay at Ambururu Waterfalls & Resort in Siaya, Kenya with real-time availability, 360° room tours with hotspots, AI suggestions, and secure payments (M-Pesa, PayPal, pay on arrival).">
    <meta name="keywords" content="Ambururu Waterfalls, Siaya, Kenya, booking, resort, M-Pesa, PayPal, 360 tour, secure">
    <title>Book Your Stay - Ambururu Waterfalls</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/ScrollTrigger.min.js"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=AaKjsRN_r_62rxV_8WGNEo32fcXTeCPdhHpzvNTEN9ZGEGKOFQOHc921e4I1seyE1Q3JxdVL4SEhkDPUR"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-confetti@0.11.0/dist/js-confetti.browser.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script src="js/script.js"></script>
</head>
<body>
    <header class="sticky-header">
        <div class="header-container">
            <div class="header-brand">
                <img src="logo/B2.jpg" alt="Ambururu Waterfalls Logo" class="logo">
                <h1>Ambururu Waterfalls</h1>
            </div>
            <div class="search-bar">
                <input type="text" placeholder="Search..." aria-label="Search site">
                <button type="submit" aria-label="Search"><i class="fas fa-search"></i></button>
            </div>
            <nav id="main-nav" aria-label="Main navigation">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li class="dropdown">
                        <a href="about.html">About <i class="fas fa-chevron-down"></i></a>
                        <ul class="dropdown-menu">
                            <li><a href="about.html#history">History</a></li>
                            <li><a href="about.html#location">Location</a></li>
                        </ul>
                    </li>
                    <li><a href="gallery.html">Gallery</a></li>
                    <li class="dropdown">
                        <a href="activities.html">Activities <i class="fas fa-chevron-down"></i></a>
                        <ul class="dropdown-menu">
                            <li><a href="activities.html#swimming">Swimming</a></li>
                            <li><a href="activities.html#hiking">Hiking</a></li>
                        </ul>
                    </li>
                    <li><a href="accommodations.html">Accommodations</a></li>
                    <li><a href="dining.html">Dining</a></li>
                    <li><a href="events.html">Events</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><a href="blog.html">Blog</a></li>
                    <li><a href="booking.html" class="active" aria-current="page">Book Now</a></li>
                </ul>
            </nav>
            <button class="menu-toggle" aria-label="Toggle menu"><i class="fas fa-bars"></i></button>
        </div>
        <div id="loading-modal" class="modal" style="display:none;">
            <div class="modal-content">
                <i class="fas fa-spinner fa-spin"></i> Processing...
            </div>
        </div>
        <div id="confirmation-modal" class="modal" style="display:none;">
            <div class="modal-content">
                <span class="modal-close" onclick="$('#confirmation-modal').hide();">×</span>
                <h3>Booking Confirmed!</h3>
                <p>Thank you for booking with Ambururu Waterfalls. You’ve earned <span id="loyalty-points">50</span> loyalty points!</p>
                <button onclick="$('#confirmation-modal').hide();">Close</button>
            </div>
        </div>
        <div id="360-modal" class="modal" style="display:none;">
            <div class="modal-content">
                <span class="modal-close" onclick="$('#360-modal').hide();">×</span>
                <div id="pannellum-viewer" style="width:100%;height:500px;"></div>
            </div>
        </div>
    </header>

    <main>
        <section class="hero parallax" aria-label="Booking hero section">
            <div id="particles-js" class="particles-bg"></div>
            <video class="hero-video" autoplay muted loop playsinline>
                <source src="images/41.mp4" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <div class="hero-overlay aurora-bg">
                <h2 class="hero-title">Your Dream Getaway Awaits</h2>
                <p class="hero-subtitle" id="dynamic-subtitle">Book now for an unforgettable experience!</p>
                <div class="urgency-timer">
                    <p>Special Offer: Book within <span id="countdown">24:00:00</span> for 15% off!</p>
                </div>
                <div class="live-counter">
                    <p><i class="fas fa-users"></i> <span id="booking-counter">127</span> bookings this week!</p>
                </div>
                <a href="#booking-wizard" class="cta-button pulse">Start Booking</a>
            </div>
        </section>

        <section class="testimonials">
            <h2>Guest Experiences</h2>
            <div class="testimonial-slider">
                <div class="testimonial">
                    <p>"A magical escape! The falls and luxurious rooms were beyond our expectations."</p>
                    <p class="author">– Jane M., Nairobi</p>
                </div>
                <div class="testimonial">
                    <p>"Booking was seamless, and the staff made our stay unforgettable. Highly recommend!"</p>
                    <p class="author">– David K., Mombasa</p>
                </div>
                <div class="testimonial">
                    <p>"The perfect getaway! Stunning views, amazing food, and top-notch service."</p>
                    <p class="author">– Sarah W., Kisumu</p>
                </div>
            </div>
            <div class="trust-badges">
                <img src="logo/B5.jpg" alt="Secure booking badge" class="badge">
                <img src="logo/B4.jpg" alt="Satisfaction guarantee badge" class="badge">
                <img src="logo/B3.jpg" alt="PayPal verified badge" class="badge">
            </div>
        </section>
        

        <section class="booking" id="booking-wizard">
            <h2>Book Your Stay</h2>
            <div class="progress-bar">
                <div class="progress-step active" data-step="1" title="Select your dates"><i class="fas fa-calendar"></i> Dates <span class="step-check"><i class="fas fa-check"></i></span></div>
                <div class="progress-step" data-step="2" title="Choose your room"><i class="fas fa-bed"></i> Room <span class="step-check"><i class="fas fa-check"></i></span></div>
                <div class="progress-step" data-step="3" title="Enter your details"><i class="fas fa-user"></i> Details <span class="step-check"><i class="fas fa-check"></i></span></div>
                <div class="progress-step" data-step="4" title="Complete payment"><i class="fas fa-credit-card"></i> Payment <span class="step-check"><i class="fas fa-check"></i></span></div>
            </div>
            <div class="booking-container">
                <form id="booking-form-element" action="https://formspree.io/f/xbloeqdy" method="POST" class="animated-form">
                    <input type="hidden" id="booking-id" name="booking-id">
                    <div class="form-step active" data-step="1">
                        <div id="availability-calendar"></div>
                        <div class="form-group">
                            <label for="checkin">Check-in Date</label>
                            <input type="date" id="checkin" name="checkin" required aria-label="Check-in date" title="Select your check-in date">
                        </div>
                        <div class="form-group">
                            <label for="checkout">Check-out Date</label>
                            <input type="date" id="checkout" name="checkout" required aria-label="Check-out date" title="Select your check-out date">
                        </div>
                        <div class="form-group">
                            <label for="guests">Number of Guests</label>
                            <select id="guests" name="guests" required aria-label="Number of guests" title="Select number of guests">
                                <option value="" disabled selected>Select guests</option>
                                <option value="1">1 Guest</option>
                                <option value="2">2 Guests</option>
                                <option value="3">3 Guests</option>
                                <option value="4">4 Guests</option>
                            </select>
                        </div>
                        <p id="ai-suggestion" class="ai-suggestion"></p>
                        <p id="step-error" class="form-error" style="display:none;" aria-live="polite"></p>
                        <button type="button" class="cta-button next-step" data-next="2">Next</button>
                    </div>
                    <div class="form-step" data-step="2">
                        <div class="room-previews">
                            <div class="room-preview" data-room="standard">
                                <div class="room-canvas" id="standard-canvas"></div>
                                <h3>Standard Room</h3>
                                <p>$100/night</p>
                                <button type="button" class="view-360" data-panorama="images/standard-360.jpg">View 360° Tour</button>
                                <button type="button" class="view-ar" data-room="standard">AR Preview</button>
                            </div>
                            <div class="room-preview" data-room="deluxe">
                                <div class="room-canvas" id="deluxe-canvas"></div>
                                <h3>Deluxe Room</h3>
                                <p>$150/night</p>
                                <button type="button" class="view-360" data-panorama="images/deluxe-360.jpg">View 360° Tour</button>
                                <button type="button" class="view-ar" data-room="deluxe">AR Preview</button>
                            </div>
                            <div class="room-preview" data-room="suite">
                                <div class="room-canvas" id="suite-canvas"></div>
                                <h3>Suite</h3>
                                <p>$200/night</p>
                                <button type="button" class="view-360" data-panorama="images/suite-360.jpg">View 360° Tour</button>
                                <button type="button" class="view-ar" data-room="suite">AR Preview</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="room">Select Room Type</label>
                            <select id="room" name="room" required aria-label="Room type" title="Select your room type">
                                <option value="" disabled selected>Select room</option>
                                <option value="standard">Standard ($100/night)</option>
                                <option value="deluxe">Deluxe ($150/night)</option>
                                <option value="suite">Suite ($200/night)</option>
                            </select>
                        </div>
                        <p id="availability-status" class="availability-status" aria-live="polite"></p>
                        <button type="button" class="cta-button prev-step" data-prev="1">Back</button>
                        <button type="button" class="cta-button next-step" data-next="3">Next</button>
                    </div>
                    <div class="form-step" data-step="3">
                        <div class="form-group">
                            <label for="name">Name</label>
                            <input type="text" id="name" name="name" required aria-label="Your name" title="Enter your full name">
                            <button type="button" class="voice-input" data-target="name" aria-label="Voice input for name"><i class="fas fa-microphone"></i></button>
                        </div>
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email" required aria-label="Your email" title="Enter your email address">
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone</label>
                            <input type="tel" id="phone" name="phone" required aria-label="Your phone number" title="Enter your phone number">
                            <button type="button" class="voice-input" data-target="phone" aria-label="Voice input for phone"><i class="fas fa-microphone"></i></button>
                        </div>
                        <div class="form-group">
                            <label for="requests">Special Requests</label>
                            <textarea id="requests" name="requests" rows="3" aria-label="Special requests" title="Enter any special requests"></textarea>
                        </div>
                        <button type="button" class="cta-button prev-step" data-prev="2">Back</button>
                        <button type="button" class="cta-button next-step" data-next="4">Next</button>
                    </div>
                    <div class="form-step" data-step="4">
                        <p id="total-cost" class="total-cost" aria-live="polite"></p>
                        <div class="form-group">
                            <label for="payment-method">Payment Method</label>
                            <select id="payment-method" name="payment-method" required aria-label="Payment method" title="Select payment method">
                                <option value="" disabled selected>Select payment method</option>
                                <option value="mpesa">M-Pesa</option>
                                <option value="paypal">PayPal</option>
                                <option value="on-arrival">Pay on Arrival</option>
                            </select>
                        </div>
                        <div id="mpesa-details" class="payment-details" style="display:none;">
                            <p>Pay via M-Pesa to: <strong>+254720215511</strong></p>
                            <p>Enter Transaction ID:</p>
                            <input type="text" id="mpesa-transaction-id" name="transaction-id" aria-label="M-Pesa transaction ID" title="Enter M-Pesa transaction ID">
                        </div>
                        <div id="paypal-button-container" class="payment-details" style="display:none;"></div>
                        <div id="on-arrival-details" class="payment-details" style="display:none;">
                            <p>Payment will be processed during check-in at Ambururu Waterfalls.</p>
                        </div>
                        <div class="trust-badges payment-badges">
                            <img src="logo/B5.jpg" alt="Secure booking badge" class="badge">
                            <img src="logo/B4.jpg" alt="Satisfaction guarantee badge" class="badge">
                            <img src="logo/B3.jpg" alt="PayPal verified badge" class="badge">
                        </div>
                        <div class="discount-wheel">
                            <canvas id="discount-wheel" width="200" height="200" aria-label="Spin for a discount"></canvas>
                            <button type="button" id="spin-wheel" class="cta-button">Spin for a Discount!</button>
                            <p id="discount-result" class="discount-result" aria-live="polite"></p>
                        </div>
                        <button type="button" class="cta-button prev-step" data-prev="3">Back</button>
                        <button type="submit" class="cta-button">Confirm Reservation</button>
                        <p id="form-error" class="form-error" style="display:none;" aria-live="polite"></p>
                        <p id="form-success" class="form-success" style="display:none;" aria-live="alert">Booking confirmed successfully!</p>
                    </div>
                </form>
                <aside class="booking-summary">
                    <h3>Your Reservation</h3>
                    <p><strong>Check-in:</strong> <span id="summary-checkin">-</span></p>
                    <p><strong>Check-out:</strong> <span id="summary-checkout">-</span></p>
                    <p><strong>Guests:</strong> <span id="summary-guests">-</span></p>
                    <p><strong>Room:</strong> <span id="summary-room">-</span></p>
                    <p><strong>Total:</strong> <span id="summary-total">-</span></p>
                </aside>
            </div>
        </section>
    </main>

    <footer>
        <div class="footer-container">
            <p>© 2025 Ambururu Waterfalls. All rights reserved.</p>
            <div class="social-links">
                <a href="https://www.facebook.com/ambururu/" target="_blank" aria-label="Visit Ambururu Waterfalls on Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="https://x.com/Ambururu_W" target="_blank" aria-label="Visit Ambururu Waterfalls on X"><i class="fab fa-x-twitter"></i></a>
            </div>
            <div class="newsletter">
                <h4>Stay Updated</h4>
                <form id="newsletter-form" action="https://formspree.io/f/xbloeqdy" method="POST">
                    <input type="email" name="email" placeholder="Enter your email" required aria-label="Email for newsletter">
                    <button type="submit" class="cta-button">Subscribe</button>
                </form>
            </div>
        </div>
    </footer>

    <script>
        var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
        (function(){
            var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
            s1.async=true;
            s1.src='https://embed.tawk.to/68360ce00f6bcf190fc26624/1is9i4jf2';
            s1.charset='UTF-8';
            s1.setAttribute('crossorigin','*');
            s0.parentNode.insertBefore(s1,s0);
        })();
    </script>

    <script>
        gsap.registerPlugin(ScrollTrigger);

        // Animations
        gsap.from(".hero-title", { opacity: 0, y: 50, duration: 1.5, ease: "power2.out", delay: 0.5 });
        gsap.from(".hero-subtitle", { opacity: 0, y: 50, duration: 1.5, ease: "power2.out", delay: 0.7 });
        gsap.from(".urgency-timer", { opacity: 0, y: 20, duration: 1, ease: "power2.out", delay: 0.9 });
        gsap.from(".live-counter", { opacity: 0, y: 20, duration: 1, ease: "power2.out", delay: 1.1 });
        gsap.from(".hero .cta-button", { opacity: 0, scale: 0.8, duration: 1, ease: "elastic.out(1, 0.5)", delay: 1.3 });

        gsap.from(".testimonials", { opacity: 0, y: 100, duration: 1, scrollTrigger: { trigger: ".testimonials", start: "top 80%" } });
        gsap.from(".booking", { opacity: 0, y: 100, duration: 1, scrollTrigger: { trigger: ".booking", start: "top 80%" } });

        gsap.utils.toArray(".form-step").forEach(step => {
            gsap.from(step, { opacity: 0, x: 50, duration: 0.5, scrollTrigger: { trigger: step, start: "top 90%" } });
        });

        $(window).on('scroll', function() {
            if ($(this).scrollTop() > 50) {
                $('.sticky-header').addClass('scrolled');
            } else {
                $('.sticky-header').removeClass('scrolled');
            }
        });

        $(document).ready(function() {
            console.log('Document ready. jQuery version:', $.fn.jquery);

            // Particles.js
            particlesJS('particles-js', {
                particles: {
                    number: { value: 100, density: { enable: true, value_area: 800 } },
                    color: { value: '#ffffff' },
                    shape: { type: 'circle' },
                    opacity: { value: 0.6, random: true },
                    size: { value: 3, random: true },
                    line_linked: { enable: true, distance: 150, color: '#ffffff', opacity: 0.4, width: 1 },
                    move: { enable: true, speed: 4, direction: 'none', random: false }
                },
                interactivity: {
                    detect_on: 'canvas',
                    events: { onhover: { enable: true, mode: 'repulse' }, onclick: { enable: true, mode: 'push' } },
                    modes: { repulse: { distance: 100, duration: 0.4 } }
                }
            });

            // Hero subtitle rotation
            const subtitles = [
                "Book now for an unforgettable experience!",
                "Discover paradise with exclusive deals!",
                "Your adventure starts with a click!",
                "Secure your spot at Ambururu today!"
            ];
            let subtitleIndex = 0;
            function rotateSubtitle() {
                gsap.to("#dynamic-subtitle", { opacity: 0, duration: 0.3, onComplete: () => {
                    $('#dynamic-subtitle').text(subtitles[subtitleIndex]);
                    gsap.to("#dynamic-subtitle", { opacity: 1, duration: 0.3 });
                    subtitleIndex = (subtitleIndex + 1) % subtitles.length;
                }});
            }
            rotateSubtitle();
            setInterval(rotateSubtitle, 5000);

            // Countdown timer
            function startCountdown() {
                let time = 24 * 60 * 60;
                const countdownElement = $('#countdown');
                setInterval(() => {
                    const hours = Math.floor(time / 3600);
                    const minutes = Math.floor((time % 3600) / 60);
                    const seconds = time % 60;
                    countdownElement.text(`${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`);
                    time--;
                    if (time < 0) time = 24 * 60 * 60;
                }, 1000);
            }
            startCountdown();

            // Booking counter
            let bookingCount = 127;
            setInterval(() => {
                bookingCount += Math.floor(Math.random() * 3);
                $('#booking-counter').text(bookingCount);
            }, 30000);

            // Testimonial slider
            let currentTestimonial = 0;
            const testimonials = $('.testimonial');
            function rotateTestimonials() {
                testimonials.hide();
                testimonials.eq(currentTestimonial).fadeIn(500);
                currentTestimonial = (currentTestimonial + 1) % testimonials.length;
            }
            rotateTestimonials();
            setInterval(rotateTestimonials, 5000);

            // FullCalendar
            const calendarEl = document.getElementById('availability-calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                selectable: true,
                select: function(arg) {
                    console.log('Calendar select:', arg.startStr, arg.endStr);
                    $('#checkin').val(arg.startStr);
                    const endDate = new Date(arg.endStr);
                    endDate.setDate(endDate.getDate() - 1);
                    $('#checkout').val(endDate.toISOString().split('T')[0]);
                    checkAvailability();
                    calculateTotal();
                    suggestRoom();
                    updateSummary();
                },
                events: [
                    { title: 'Booked', start: '2025-06-01', end: '2025-06-03', color: '#e63946' },
                    { title: 'Booked', start: '2025-06-10', end: '2025-06-12', color: '#e63946' }
                ]
            });
            calendar.render();

            // Step navigation
            $(document).on('click', '.next-step', function(e) {
                e.preventDefault();
                console.log('Next button clicked');
                const $button = $(this);
                const nextStep = $button.data('next');
                const currentStep = $button.closest('.form-step').data('step');
                console.log('Current step:', currentStep, 'Next step:', nextStep);

                let isValid = true;
                $('#step-error, #form-error, #availability-status').hide();

                if (currentStep === 1) {
                    isValid = validateStep1();
                } else if (currentStep === 2) {
                    isValid = !!$('#room').val();
                    if (!isValid) $('#availability-status').text('Please select a room type.').css('color', '#e63946').show();
                } else if (currentStep === 3) {
                    isValid = $('#name').val() && $('#email').val() && $('#phone').val();
                    if (!isValid) $('#form-error').text('Please fill in all required fields.').show();
                }

                if (isValid) {
                    $button.prop('disabled', true).text('Loading...');
                    $('.form-step').removeClass('active');
                    $(`.form-step[data-step="${nextStep}"]`).addClass('active');
                    $('.progress-step').removeClass('active');
                    $(`.progress-step[data-step="${nextStep}"]`).addClass('active');
                    $(`.progress-step[data-step="${currentStep}"] .step-check`).addClass('visible');
                    gsap.from(`.form-step[data-step="${nextStep}"]`, { opacity: 0, x: 50, duration: 0.5 });
                    gsap.to('.progress-bar', { '--progress': `${nextStep * 25}%`, duration: 0.5 });
                    setTimeout(() => $button.prop('disabled', false).text('Next'), 500);
                    new Audio('https://freesound.org/data/previews/170/170621_2885980-lq.mp3').play().catch(() => {});
                } else {
                    gsap.to($button, { x: -10, duration: 0.1, repeat: 3, yoyo: true });
                    console.log('Validation failed for step', currentStep);
                }
            });

            $(document).on('click', '.prev-step', function(e) {
                e.preventDefault();
                const prevStep = $(this).data('prev');
                $('.form-step').removeClass('active');
                $(`.form-step[data-step="${prevStep}"]`).addClass('active');
                $('.progress-step').removeClass('active');
                $(`.progress-step[data-step="${prevStep}"]`).addClass('active');
                $(`.progress-step[data-step="${prevStep + 1}"] .step-check`).removeClass('visible');
                gsap.from(`.form-step[data-step="${prevStep}"]`, { opacity: 0, x: -50, duration: 0.5 });
                gsap.to('.progress-bar', { '--progress': `${prevStep * 25}%`, duration: 0.5 });
            });

            // Step 1 Validation
            function validateStep1() {
                const checkin = $('#checkin').val();
                const checkout = $('#checkout').val();
                const guests = $('#guests').val();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const stepError = $('#step-error');

                console.log('Validating Step 1:', { checkin, checkout, guests });

                if (!checkin) {
                    stepError.text('Please select a check-in date.').show();
                    return false;
                }
                if (!checkout) {
                    stepError.text('Please select a check-out date.').show();
                    return false;
                }
                if (!guests) {
                    stepError.text('Please select the number of guests.').show();
                    return false;
                }

                const checkinDate = new Date(checkin);
                const checkoutDate = new Date(checkout);

                if (isNaN(checkinDate.getTime())) {
                    stepError.text('Invalid check-in date format.').show();
                    return false;
                }
                if (isNaN(checkoutDate.getTime())) {
                    stepError.text('Invalid check-out date format.').show();
                    return false;
                }

                if (checkinDate < today) {
                    stepError.text('Check-in date cannot be in the past.').show();
                    return false;
                }
                if (checkoutDate <= checkinDate) {
                    stepError.text('Check-out must be after check-in.').show();
                    return false;
                }

                if (!checkAvailability()) {
                    stepError.text('No rooms available for selected dates.').show();
                    return false;
                }

                stepError.hide();
                return true;
            }

            // Booking Summary
            function updateSummary() {
                $('#summary-checkin').text($('#checkin').val() || '-');
                $('#summary-checkout').text($('#checkout').val() || '-');
                $('#summary-guests').text($('#guests').val() || '-');
                $('#summary-room').text($('#room option:selected').text() || '-');
                $('#summary-total').text($('#total-cost').text() || '-');
            }

            // AI Room Suggestion
            function suggestRoom() {
                const guests = parseInt($('#guests').val()) || 0;
                const checkin = new Date($('#checkin').val());
                const checkout = new Date($('#checkout').val());
                const nights = checkin && checkout ? Math.round((checkout - checkin) / (1000 * 60 * 60 * 24)) : 0;
                let suggestion = '';
                if (guests >= 3 || nights > 5) {
                    suggestion = `Perfect for ${guests} guests and ${nights} nights: Our Suite offers spacious luxury!`;
                } else if (guests === 2) {
                    suggestion = `Ideal for couples: The Deluxe Room is cozy and romantic for ${nights} nights!`;
                } else if (guests === 1) {
                    suggestion = `Solo traveler? The Standard Room is just right for your ${nights}-night stay!`;
                } else {
                    suggestion = 'Select guests to get a personalized room suggestion!';
                }
                $('#ai-suggestion').text(suggestion).css('color', 'var(--aqua-blue)');
                gsap.from('#ai-suggestion', { opacity: 0, y: 10, duration: 0.3 });
            }

            // Availability
            function checkAvailability() {
                const checkin = new Date($('#checkin').val());
                const checkout = new Date(document.getElementById('Checkout').value);
                const availabilityStatus = $('#availability-status');

                if (checkin && checkout && checkout > checkin) {
                    const bookedDates = [
                        { start: new Date('2025-06-01'), end: new Date('2025-06-03') },
                        { start: new Date('2025-06-10'), end: new Date('2025-06-12') }
                    ];
                    const available = !bookedDates.some(range => 
                        return (
                            (checkin >= range.start && checkin <= range.end) ||
                            (checkout >= range.start && checkout <= range.end) ||
                            (checkin <= range.start && checkout >= range.end)
                        );
                    });
                    availabilityStatus.text(available ? 'Rooms available!' : 'No rooms available, please try a different dates.').css('color', available ? 'var(--aqua-blue)' : '#e63946').show();
                    return available;
                } else {
                    availabilityStatus.text('Please select a valid dates.').css('color', '#e63946').show();
                    return false;
                }
            }

            // Total cost
            function calculateTotal() {
                const checkin = new Date(document.getElementById('checkin').value);
                const checkout = new Date(document.getElementById('Checkout').value);
                const roomType = $('#room').val();
                const rates = { standard: 100, deluxe: 150, suite: 200 };
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const totalCostElement = $('#total-cost');

                if (checkin < today) {
                    totalCostElement.text("Check-in date cannot be in the past.").css('color', '#e63946');
                    return 0;
                }
                if (checkout <= checkin) {
                    totalCostElement.text("Check-out must be after check-in.").css('color', '#e63946');
                    return 0;
                }

                if (checkin && checkout && roomType) {
                    const nights = Math.round((checkout - checkin) / (1000 * 60 * 60 * 24));
                    if (nights > 0) {
                        let total = nights * rates[roomType];
                        const discount = parseFloat($('#discount-result').data('discount') || 0);
                        if (discount) total *= (1 - discount / 100);
                        totalCostElement.text(`Estimated Total: $${total.toFixed(2)} ${discount ? `(includes ${discount}% discount)` : ''}`).css('color', 'var(--coral)');
                        updateSummary();
                        return total;
                    }
                }
                totalCostElement.text('');
                return 0;
            }

            $('#guests, #checkin, #checkout, #room').on('change', () => {
                checkAvailability();
                calculateTotal();
                suggestRoom();
                updateSummary();
            });

            // Payment method
            $('#payment-method').on('change', function() {
                $('.payment-details').hide();
                if (this.value === 'mpesa') $('#mpesa-details').fadeIn(300);
                else if (this.value === 'paypal') $('#paypal-button-container').fadeIn(300);
                else if (this.value === 'on-arrival') $('#on-arrival-details').fadeIn(300);
            });

            // PayPal
            paypal.Buttons({
                createOrder: function(data, actions) {
                    const total = calculateTotal();
                    if (!total || !checkAvailability()) {
                        $('#form-error').text('Please complete the form and ensure rooms are available.').show();
                        return;
                    }
                    return actions.order.create({
                        purchase_units: [{ amount: { value: total.toString() } }]
                    });
                },
                onApprove: function(data, actions) {
                    $('#loading-modal').show();
                    return actions.order.capture().then(function(details) {
                        $('#loading-modal').hide();
                        $('#confirmation-modal').show();
                        const confetti = new JSConfetti();
                        confetti.addConfetti({ emojis: ['🎉', '🏞️', '🌊'] });
                        $('#booking-form-element')[0].reset();
                        $('#total-cost').text('');
                        $('.payment-details').hide();
                        $('.form-step').removeClass('active');
                        $('.progress-step').removeClass('active');
                        $('.step-check').removeClass('visible');
                        $('.form-step[data-step="1"]').addClass('active');
                        $('.progress-step[data-step="1"]').addClass('active');
                        gsap.to('.progress-bar', { '--progress': '25%', duration: 0.5 });
                        updateSummary();
                        new Audio('https://freesound.org/data/previews/511/511484_6890478-lq.mp3').play().catch(() => {});
                    });
                },
                onError: function(err) {
                    $('#loading-modal').hide();
                    $('#form-error').text('PayPal payment failed. Please try again.').show();
                    console.error('PayPal error:', err);
                }
            }).render('#paypal-button-container');

            // Form submission
            $('#booking-form-element').on('submit', function(e) {
                e.preventDefault();
                const paymentMethod = $('#payment-method').val();
                const mpesaTransactionId = $('#mpesa-transaction-id').val();

                if (!checkAvailability()) {
                    $('#form-error').text('No rooms available for selected dates.').show();
                    return;
                }
                if (paymentMethod === 'mpesa' && !mpesaTransactionId) {
                    $('#form-error').text('Please enter a valid M-Pesa transaction ID.').show();
                    return;
                }

                $('#loading-modal').show();
                $.ajax({
                    url: this.action,
                    method: this.method,
                    data: $(this).serialize(),
                    success: function() {
                        $('#loading-modal').hide();
                        $('#form-success').show();
                        const confetti = new JSConfetti();
                        confetti.addConfetti({ emojis: ['🎉', '🏞️', '🌊'] });
                        $('#booking-form-element')[0].reset();
                        $('#total-cost').text('');
                        $('.payment-details').hide();
                        $('.form-step').removeClass('active');
                        $('.progress-step').removeClass('active');
                        $('.step-check').removeClass('visible');
                        $('.form-step[data-step="1"]').addClass('active');
                        $('.progress-step[data-step="1"]').addClass('active');
                        gsap.to('.progress-bar', { '--progress': '25%', duration: 0.5 });
                        gsap.fromTo("#form-success", { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.5 });
                        setTimeout(() => $('#form-success').fadeOut(), 5000);
                        updateSummary();
                        new Audio('https://freesound.org/data/previews/511/511484_6890478-lq.mp3').play().catch(() => {});
                    },
                    error: function(xhr, status, error) {
                        $('#loading-modal').hide();
                        $('#form-error').text('An error occurred. Please try again.').show();
                        console.error('Form submission error:', status, error);
                    }
                });
            });

            // 360° Viewer
            $('.view-360').on('click', function() {
                const panorama = $(this).data('panorama');
                $('#360-modal').fadeIn(300);
                pannellum.viewer('pannellum-viewer', {
                    type: 'equirectangular',
                    panorama: panorama,
                    autoLoad: true,
                    autoRotate: -2,
                    hotSpots: [
                        { pitch: 10, yaw: 180, type: 'info', text: 'King-Size Bed' },
                        { pitch: -10, yaw: 90, type: 'info', text: 'Scenic Balcony' },
                        { pitch: 0, yaw: 0, type: 'info', text: 'Luxury Bath' }
                    ]
                });
            });

            // AR Preview
            $('.view-ar').on('click', function() {
                alert('AR Preview is not fully supported. Please view the 360° tour or contact us for a demo.');
            });

            // Three.js Previews
            function initRoomPreview(canvasId, color) {
                const canvas = document.getElementById(canvasId);
                if (!canvas) {
                    console.error(`Canvas ${canvasId} not found.`);
                    return;
                }
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
                renderer.setSize(100, 100);

                const geometry = new THREE.BoxGeometry(1, 1, 1);
                const material = new THREE.MeshBasicMaterial({ color: color });
                const room = new THREE.Mesh(geometry, material);
                scene.add(room);

                camera.position.z = 2;

                function animate() {
                    requestAnimationFrame(animate);
                    room.rotation.x += 0.01;
                    room.rotation.y += 0.01;
                    renderer.render(scene, camera);
                }
                animate();
            }

            initRoomPreview('standard-canvas', 0x4DD0E1);
            initRoomPreview('deluxe-canvas', 0xFF6347);
            initRoomPreview('suite-canvas', 0xFFD700);

            // Discount Wheel
            const wheelCanvas = document.getElementById('discount-wheel');
            const wheelCtx = wheelCanvas.getContext('2d');
            const discounts = [
                { value: 0, label: 'Try Again', color: '#e63946' },
                { value: 5, label: '5% Off', color: '#4dd0e1' },
                { value: 10, label: '10% Off', color: '#ff6347' },
                { value: 15, label: '15% Off', color: '#ffd700' }
            ];
            function drawWheel() {
                const arcSize = (2 * Math.PI) / discounts.length;
                wheelCtx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
                discounts.forEach((item, index) => {
                    wheelCtx.beginPath();
                    wheelCtx.fillStyle = item.color;
                    wheelCtx.moveTo(100, 100);
                    wheelCtx.arc(100, 100, 100, index * arcSize, (index + 1) * arcSize);
                    wheelCtx.fill();
                    wheelCtx.save();
                    wheelCtx.translate(100, 100);
                    wheelCtx.rotate(index * arcSize + arcSize / 2);
                    wheelCtx.fillStyle = '#fff';
                    wheelCtx.font = '16px Roboto';
                    wheelCtx.fillText(item.label, 50, 10);
                    wheelCtx.restore();
                });
            }
            drawWheel();

            $('#spin-wheel').on('click', function() {
                const spins = 5 + Math.random() * 5;
                const finalAngle = spins * 360 + Math.random() * 360;
                gsap.to(wheelCanvas, {
                    rotation: finalAngle,
                    duration: 3,
                    ease: 'power2.out',
                    onComplete: () => {
                        const index = Math.floor((finalAngle % 360) / (360 / discounts.length));
                        const discount = discounts[index].value;
                        $('#discount-result').text(discount ? `You won a ${discount}% discount!` : 'Try again next time!').data('discount', discount);
                        gsap.from('#discount-result', { opacity: 0, y: 20, duration: 0.3 });
                        calculateTotal();
                        new Audio('https://freesound.org/data/previews/120/120375_1670642-lq.mp3').play().catch(() => {});
                    }
                });
            });

            // Voice Input
            if ('webkitSpeechRecognition' in window) {
                const recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;

                $('.voice-input').on('click', function() {
                    const target = $(this).data('target');
                    recognition.start();
                    recognition.onresult = function(event) {
                        const transcript = event.results[0][0].transcript;
                        $(`#${target}`).val(transcript);
                    };
                    recognition.onerror = function() {
                        console.error('Voice input failed.');
                        alert('Voice input failed. Please try again.');
                    };
                });
            } else {
                $('.voice-input').hide();
            }

            // Smooth scrolling
            $('a[href^="#"]').on('click', function(e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({ behavior: 'smooth' });
            });

            // Tooltips
            $('input, select').on('focus', function() {
                const title = $(this).attr('title');
                if (title) {
                    const $tooltip = $('<div class="tooltip"></div>').text(title);
                    $(this).after($tooltip);
                    gsap.from($tooltip, { opacity: 0, y: 10, duration: 0.3 });
                }
            }).on('blur', function() {
                $('.tooltip').remove();
            });

            // Initialize
            checkAvailability();
            calculateTotal();
            suggestRoom();
            updateSummary();
        });
    </script>
</body>
</html>